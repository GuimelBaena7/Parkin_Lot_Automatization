<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Detecci√≥n de Placas - 3 Opciones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .opciones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h2::before {
            font-size: 1.5em;
        }
        
        .opcion1 h2::before { content: "üì±"; }
        .opcion2 h2::before { content: "üé•"; }
        .opcion3 h2::before { content: "üóÑÔ∏è"; }
        
        video, img, canvas {
            width: 100%;
            max-width: 100%;
            border: 2px solid #667eea;
            border-radius: 10px;
            margin: 15px 0;
            display: block;
        }
        
        canvas {
            display: none;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin: 10px 0;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s, transform 0.1s;
            margin-top: 10px;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }
        
        .status.conectado {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.desconectado {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.procesando {
            background: #cfe2ff;
            color: #084298;
            border: 1px solid #b6d4fe;
        }
        
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 14px;
            color: #555;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
        }
        
        .stat-label {
            color: #999;
            font-size: 11px;
            margin-bottom: 5px;
        }
        
        .stat-value {
            color: #667eea;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Sistema de Detecci√≥n de Placas</h1>
        
        <div class="opciones">
            <!-- OPCI√ìN 1: C√°mara Local -->
            <div class="card opcion1">
                <h2>C√°mara Local</h2>
                <div class="info-box">
                    Usa la c√°mara de tu dispositivo (celular/PC)
                </div>
                <video id="video1" width="400" height="300" autoplay playsinline></video>
                <canvas id="canvas1" width="400" height="300"></canvas>
                <img id="result1" alt="Procesando..." style="display:none;">
                <button onclick="iniciarCamaraLocal()">üé¨ Iniciar C√°mara</button>
                <button onclick="detenerCamaraLocal()" style="background: #dc3545;">‚èπÔ∏è Detener</button>
                <div class="status desconectado" id="status1">Desconectado</div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">FPS</div>
                        <div class="stat-value" id="fps1">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Latencia</div>
                        <div class="stat-value" id="latencia1">0ms</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Estado</div>
                        <div class="stat-value" id="estado1">-</div>
                    </div>
                </div>
            </div>
            
            <!-- OPCI√ìN 2: C√°mara IP Directa -->
            <div class="card opcion2">
                <h2>C√°mara IP (URL)</h2>
                <div class="info-box">
                    Conecta una c√°mara IP sin registrar
                </div>
                <input id="url-input" type="text" placeholder="rtsp://usuario:pass@192.168.1.100/stream">
                <small style="color: #999;">Tambi√©n soporta HTTP: http://192.168.1.100:8080/video</small>
                <img id="result2" alt="Procesando..." style="display:none;">
                <button onclick="conectarCamaraIP()">üîó Conectar C√°mara IP</button>
                <button onclick="desconectarCamaraIP()" style="background: #dc3545;">‚ùå Desconectar</button>
                <div class="status desconectado" id="status2">Desconectado</div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">FPS</div>
                        <div class="stat-value" id="fps2">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Latencia</div>
                        <div class="stat-value" id="latencia2">0ms</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Frames</div>
                        <div class="stat-value" id="frames2">0</div>
                    </div>
                </div>
            </div>
            
            <!-- OPCI√ìN 3: C√°mara Registrada en BD -->
            <div class="card opcion3">
                <h2>C√°mara de BD</h2>
                <div class="info-box">
                    Selecciona una c√°mara registrada
                </div>
                <select id="camera-select">
                    <option value="">Cargando c√°maras...</option>
                </select>
                <img id="result3" alt="Procesando..." style="display:none;">
                <button onclick="cargarCamaras()">üîÑ Refrescar C√°maras</button>
                <button onclick="conectarCamaraBD()">üì° Conectar</button>
                <button onclick="desconectarCamaraBD()" style="background: #dc3545;">üõë Desconectar</button>
                <div class="status desconectado" id="status3">Desconectado</div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Total C√°maras</div>
                        <div class="stat-value" id="total-camaras">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Activas</div>
                        <div class="stat-value" id="camaras-activas">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Detectadas</div>
                        <div class="stat-value" id="detectadas">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- √Årea de Registro de Detecciones -->
        <div class="card" style="grid-column: 1/-1;">
            <h2>üìã Detecciones Recientes</h2>
            <div id="detecciones-list" style="max-height: 300px; overflow-y: auto;">
                <p style="color: #999; text-align: center;">Esperando detecciones...</p>
            </div>
        </div>
    </div>

    <script>
        // ============= CONFIGURACI√ìN =============
        const BACKEND_URL = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000';
        
        let ws1 = null, ws2 = null, ws3 = null;
        let stream1 = null;
        let stats = {
            opcion1: { fps: 0, latencia: 0, frames: 0 },
            opcion2: { fps: 0, latencia: 0, frames: 0 },
            opcion3: { fps: 0, latencia: 0, frames: 0 }
        };
        let lastFrameTime = {};
        
        // ============= OPCI√ìN 1: C√ÅMARA LOCAL =============
        async function iniciarCamaraLocal() {
            try {
                stream1 = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Trasera en m√≥vil, normal en PC
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                const video = document.getElementById('video1');
                video.srcObject = stream1;
                
                ws1 = new WebSocket(`${WS_URL}/ws/camara-directa`);
                ws1.binaryType = 'arraybuffer';
                
                ws1.onopen = () => {
                    actualizarStatus('status1', 'conectado', 'Conectado');
                    console.log('WebSocket 1 abierto');
                    ws1.send(JSON.stringify({ type: 'camera_local' }));
                    iniciarCaptura();
                };
                
                ws1.onmessage = (event) => {
                    const inicio = performance.now();
                    const blob = new Blob([event.data], { type: 'image/jpeg' });
                    const url = URL.createObjectURL(blob);
                    document.getElementById('result1').src = url;
                    document.getElementById('result1').style.display = 'block';
                    stats.opcion1.latencia = Math.round(performance.now() - inicio);
                    actualizarStats('opcion1');
                };
                
                ws1.onerror = (err) => {
                    console.error('Error WS1:', err);
                    actualizarStatus('status1', 'desconectado', 'Error de conexi√≥n');
                };
                
                ws1.onclose = () => {
                    actualizarStatus('status1', 'desconectado', 'Desconectado');
                };
                
            } catch (err) {
                console.error('Error acceso c√°mara:', err);
                alert('Error accediendo a la c√°mara: ' + err.message);
                actualizarStatus('status1', 'desconectado', 'Error: ' + err.message);
            }
        }
        
        function iniciarCaptura() {
            const video = document.getElementById('video1');
            const canvas = document.getElementById('canvas1');
            const fps = 10; // 10 frames por segundo
            
            setInterval(() => {
                if (!stream1 || !ws1 || ws1.readyState !== WebSocket.OPEN) return;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                canvas.toBlob(blob => {
                    if (ws1 && ws1.readyState === WebSocket.OPEN) {
                        ws1.send(blob);
                        stats.opcion1.frames++;
                        stats.opcion1.fps = Math.round(stats.opcion1.frames / 10);
                        if (stats.opcion1.frames % 10 === 0) {
                            stats.opcion1.frames = 0;
                        }
                        actualizarStats('opcion1');
                    }
                }, 'image/jpeg', 0.7);
            }, 1000 / fps);
        }
        
        function detenerCamaraLocal() {
            if (stream1) {
                stream1.getTracks().forEach(track => track.stop());
                stream1 = null;
            }
            if (ws1) {
                ws1.close();
                ws1 = null;
            }
            actualizarStatus('status1', 'desconectado', 'Detenido');
        }
        
        // ============= OPCI√ìN 2: C√ÅMARA IP =============
        function conectarCamaraIP() {
            const url = document.getElementById('url-input').value.trim();
            if (!url) {
                alert('Ingresa una URL de c√°mara');
                return;
            }
            
            ws2 = new WebSocket(`${WS_URL}/ws/camara-directa`);
            ws2.binaryType = 'arraybuffer';
            
            ws2.onopen = () => {
                actualizarStatus('status2', 'procesando', 'Conectando...');
                ws2.send(JSON.stringify({
                    type: 'camera_url',
                    url: url
                }));
                console.log('Enviada URL:', url);
            };
            
            ws2.onmessage = (event) => {
                const inicio = performance.now();
                actualizarStatus('status2', 'conectado', 'Recibiendo...');
                
                const blob = new Blob([event.data], { type: 'image/jpeg' });
                const url = URL.createObjectURL(blob);
                document.getElementById('result2').src = url;
                document.getElementById('result2').style.display = 'block';
                
                stats.opcion2.frames++;
                stats.opcion2.fps = Math.round(stats.opcion2.frames / 10);
                stats.opcion2.latencia = Math.round(performance.now() - inicio);
                
                if (stats.opcion2.frames % 10 === 0) {
                    stats.opcion2.frames = 0;
                }
                actualizarStats('opcion2');
            };
            
            ws2.onerror = (err) => {
                console.error('Error WS2:', err);
                actualizarStatus('status2', 'desconectado', 'Error de conexi√≥n');
            };
            
            ws2.onclose = () => {
                actualizarStatus('status2', 'desconectado', 'Desconectado');
            };
        }
        
        function desconectarCamaraIP() {
            if (ws2) {
                ws2.close();
                ws2 = null;
            }
            actualizarStatus('status2', 'desconectado', 'Desconectado');
        }
        
        // ============= OPCI√ìN 3: C√ÅMARA BD =============
        async function cargarCamaras() {
            try {
                const response = await fetch(`${BACKEND_URL}/camaras`);
                const camaras = await response.json();
                
                const select = document.getElementById('camera-select');
                select.innerHTML = '';
                
                if (camaras.length === 0) {
                    select.innerHTML = '<option>No hay c√°maras registradas</option>';
                } else {
                    camaras.forEach(cam => {
                        const option = document.createElement('option');
                        option.value = cam.id;
                        option.textContent = `${cam.nombre} (ID: ${cam.id})`;
                        select.appendChild(option);
                    });
                }
                
                document.getElementById('total-camaras').textContent = camaras.length;
            } catch (err) {
                console.error('Error cargando c√°maras:', err);
                alert('Error cargando c√°maras: ' + err.message);
            }
        }
        
        function conectarCamaraBD() {
            const select = document.getElementById('camera-select');
            const cam_id = select.value;
            
            if (!cam_id) {
                alert('Selecciona una c√°mara');
                return;
            }
            
            ws3 = new WebSocket(`${WS_URL}/ws/camara/${cam_id}`);
            ws3.binaryType = 'arraybuffer';
            
            ws3.onopen = () => {
                actualizarStatus('status3', 'conectado', 'Conectado');
                console.log('Conectado a c√°mara BD:', cam_id);
            };
            
            ws3.onmessage = (event) => {
                const blob = new Blob([event.data], { type: 'image/jpeg' });
                const url = URL.createObjectURL(blob);
                document.getElementById('result3').src = url;
                document.getElementById('result3').style.display = 'block';
                
                stats.opcion3.frames++;
                stats.opcion3.fps = Math.round(stats.opcion3.frames / 10);
                
                if (stats.opcion3.frames % 10 === 0) {
                    stats.opcion3.frames = 0;
                }
                actualizarStats('opcion3');
            };
            
            ws3.onerror = (err) => {
                console.error('Error WS3:', err);
                actualizarStatus('status3', 'desconectado', 'Error');
            };
            
            ws3.onclose = () => {
                actualizarStatus('status3', 'desconectado', 'Desconectado');
            };
        }
        
        function desconectarCamaraBD() {
            if (ws3) {
                ws3.close();
                ws3 = null;
            }
            actualizarStatus('status3', 'desconectado', 'Desconectado');
        }
        
        // ============= UTILIDADES =============
        function actualizarStatus(id, clase, texto) {
            const elem = document.getElementById(id);
            elem.className = 'status ' + clase;
            elem.textContent = texto;
        }
        
        function actualizarStats(opcion) {
            const stat = stats[opcion];
            const prefix = opcion === 'opcion1' ? '1' : (opcion === 'opcion2' ? '2' : '3');
            
            document.getElementById(`fps${prefix}`).textContent = stat.fps;
            document.getElementById(`latencia${prefix}`).textContent = stat.latencia + 'ms';
            if (opcion === 'opcion2') {
                document.getElementById(`frames${prefix}`).textContent = stat.frames;
            } else if (opcion === 'opcion3') {
                document.getElementById(`detectadas${prefix}`).textContent = stat.frames;
            }
        }
        
        // ============= INICIALIZACI√ìN =============
        document.addEventListener('DOMContentLoaded', () => {
            cargarCamaras();
            
            // Valores por defecto en URL
            document.getElementById('url-input').value = 'rtsp://usuario:pass@192.168.1.100/stream';
        });
    </script>
</body>
</html>
